on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'support/**'
      - 'master'
  pull_request:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'support/**'
  workflow_dispatch:

jobs:
  test-analyze:
    runs-on: ubuntu-latest
    container:
      image: plugfox/flutter:stable
      options: --user root

    steps:
      - name: ğŸ«° Check flutter version
        run: flutter --version
        
      - name: ğŸš‚ Get latest code
        uses: actions/checkout@v2

      - name: ğŸ Dart tools activation
        run: |
          dart pub global activate coverage

      - name: ğŸ‘· Install Dependencies
        timeout-minutes: 1
        run: flutter pub get

      - name: ğŸ˜Š Run codegen
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ” Check format
        timeout-minutes: 1
        run: |
          flutter format --set-exit-if-changed -l 80 .

      - name: ğŸ“ˆ Check analyzer
        timeout-minutes: 1
        run: | 
          flutter analyze --fatal-infos --fatal-warnings 

      - name: ğŸ§ª Run tests
        timeout-minutes: 2
        run: |
          flutter test --coverage         
        
      - name: ğŸ“¥ Upload coverage to Codecov
        if: ${{ github.ref == 'refs/heads/master' }}
        timeout-minutes: 1
        uses: codecov/codecov-action@v2.1.0
    
